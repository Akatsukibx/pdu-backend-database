// src/poller/cyber-snmp.js
const snmp = require("net-snmp");

function num(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : NaN;
}

function getVarValue(vb) {
  // net-snmp varbind: { oid, type, value }
  if (!vb) return null;
  const v = vb.value;
  // value ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô Buffer ‡∏´‡∏£‡∏∑‡∏≠ object ‡∏ö‡∏≤‡∏á‡πÅ‡∏ö‡∏ö
  if (Buffer.isBuffer(v)) return v.toString("utf8");
  return v;
}

function makeSession(pdu) {
  const host = pdu.ip || pdu.ip_address || pdu.host;
  const community = pdu.community || process.env.SNMP_COMMUNITY || "public";
  const timeout = Number(pdu.snmpTimeoutMs || process.env.SNMP_TIMEOUT_MS || 8000);
  const retries = Number(pdu.snmpRetries || process.env.SNMP_RETRIES || 1);

  return snmp.createSession(host, community, { timeout, retries });
}

/**
 * CyberPower OIDs (‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö OFF/ON ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì):
 * outlet status = 1.3.6.1.4.1.3808.1.1.3.3.4.1.1.4.[1..8]
 * - 0 = OFF
 * - 3 = ON
 *
 * ‡∏Ñ‡πà‡∏≤ realtime ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ: ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏° (voltage/current/power/energy ‡∏ñ‡∏π‡∏Å)
 * ‡πÅ‡∏ï‡πà‡∏ú‡∏°‡πÉ‡∏™‡πà "‡∏ï‡∏±‡∏ß‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô" ‡πÉ‡∏´‡πâ‚Äî‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö OID ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ
 */

// ‚úÖ outlet status base
const OID_OUTLET_STATUS_BASE = "1.3.6.1.4.1.3808.1.1.3.3.4.1.1.4.";

// üîß ‡∏™‡πà‡∏ß‡∏ô OID ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü/‡∏Å‡∏£‡∏∞‡πÅ‡∏™/‡∏Å‡∏≥‡∏•‡∏±‡∏á/‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô: ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∏‡∏ì‡∏≠‡πà‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
// ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢ OID ‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á 100%
// ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ú‡∏°‡πÉ‡∏™‡πà placeholder "‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡πÉ‡∏ä‡πâ" + ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô NaN
//
// ‡∏à‡∏≤‡∏Å diff ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ ON:
// 1.3.6.1.4.1.3808.1.1.3.2.3.1.1.6.1 (‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ voltage*10?)
// 1.3.6.1.4.1.3808.1.1.3.2.3.1.1.7.1 (‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ current*??)
// 1.3.6.1.4.1.3808.1.1.3.2.3.1.1.8.1 (‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ power?)
// 1.3.6.1.4.1.3808.1.1.3.2.3.1.1.10.1 (energy?)
// ‡πÅ‡∏ï‡πà‡∏™‡πÄ‡∏Å‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏à‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏ô/‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå ‡∏à‡∏∂‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö ‚Äú‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡πá‡∏î‡∏µ ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏°‚Äù
const OID_VOLTAGE = "1.3.6.1.4.1.3808.1.1.3.2.3.1.1.6.1"; // example
const OID_CURRENT = "1.3.6.1.4.1.3808.1.1.3.2.3.1.1.7.1"; // example
const OID_POWER = "1.3.6.1.4.1.3808.1.1.3.2.3.1.1.8.1";   // example
const OID_ENERGY = "1.3.6.1.4.1.3808.1.1.3.2.3.1.1.10.1"; // example

function scaleVoltage(raw) {
  // ‡∏à‡∏≤‡∏Å diff ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡πà‡∏≤ 2189/2215 ‡∏≠‡∏≤‡∏à‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á 218.9/221.5
  const n = num(raw);
  if (!Number.isFinite(n)) return NaN;
  // heuristic: ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1000 ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏£ 10
  return n > 1000 ? n / 10 : n;
}

function scaleCurrent(raw) {
  // ‡∏à‡∏≤‡∏Å diff ‡πÄ‡∏´‡πá‡∏ô 1800 ‡∏ô‡πà‡∏≤‡∏à‡∏∞ 18.00A (‡∏´‡∏≤‡∏£ 100)
  const n = num(raw);
  if (!Number.isFinite(n)) return NaN;
  return n > 100 ? n / 100 : n;
}

function scalePower(raw) {
  // ‡∏à‡∏≤‡∏Å diff ‡πÄ‡∏´‡πá‡∏ô 1850 ‡∏ô‡πà‡∏≤‡∏à‡∏∞ 1850W (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πÄ‡∏Å‡∏•) ‡πÅ‡∏ï‡πà‡∏ö‡∏≤‡∏á‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô 185.0 (‡∏´‡∏≤‡∏£ 10)
  const n = num(raw);
  if (!Number.isFinite(n)) return NaN;
  // heuristic: ‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å‡πÜ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô W ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô
  return n;
}

function scaleEnergy(raw) {
  // ‡∏à‡∏≤‡∏Å diff ‡πÄ‡∏´‡πá‡∏ô 40510 ‡∏Å‡∏±‡∏ö 15172 ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô 405.10 kWh ‡∏´‡∏£‡∏∑‡∏≠ 40510 Wh
  const n = num(raw);
  if (!Number.isFinite(n)) return NaN;
  // heuristic: ‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏ö‡∏ö‡∏´‡∏°‡∏∑‡πà‡∏ô ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏£ 100 ‡πÄ‡∏õ‡πá‡∏ô kWh
  return n > 1000 ? n / 100 : n;
}

function getAsync(session, oids) {
  return new Promise((resolve, reject) => {
    session.get(oids, (err, vbs) => {
      if (err) return reject(err);
      resolve(vbs);
    });
  });
}

async function pollCyberpower(pdu) {
  const host = pdu.ip || pdu.ip_address || pdu.host;

  const session = makeSession(pdu);

  try {
    // 1) ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ outlet 1..8 ‚úÖ (‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á)
    const outletOids = Array.from({ length: 8 }, (_, i) => `${OID_OUTLET_STATUS_BASE}${i + 1}`);
    const outletVbs = await getAsync(session, outletOids);

    const outlets = outletVbs.map((vb) => {
      const v = getVarValue(vb);
      // ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô number (0/3)
      return typeof v === "number" ? v : num(v);
    });

    // 2) ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ realtime ‡∏´‡∏•‡∏±‡∏Å (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡πà‡∏≤‡∏ô; ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ NaN)
    let voltage = NaN, current = NaN, power = NaN, energy = NaN;

    try {
      const vbs = await getAsync(session, [OID_VOLTAGE, OID_CURRENT, OID_POWER, OID_ENERGY]);
      const rawV = getVarValue(vbs[0]);
      const rawA = getVarValue(vbs[1]);
      const rawP = getVarValue(vbs[2]);
      const rawE = getVarValue(vbs[3]);

      voltage = scaleVoltage(rawV);
      current = scaleCurrent(rawA);
      power = scalePower(rawP);
      energy = scaleEnergy(rawE);
    } catch {
      // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß -> ‡πÄ‡∏≠‡∏≤ OID ‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    }

    return {
      id: pdu.id,
      name: pdu.name,
      brand: pdu.brand,
      status: "ONLINE",
      voltage,
      current,
      power,
      energy,
      outlets, // ‚úÖ ‡∏™‡πà‡∏á "‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á" (0/3) ‡πÉ‡∏´‡πâ snmpPoller ‡πÑ‡∏õ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‚óè/‚óã
    };
  } catch (err) {
    return {
      id: pdu.id,
      name: pdu.name,
      brand: pdu.brand,
      status: "OFFLINE",
      voltage: NaN,
      current: NaN,
      power: NaN,
      energy: NaN,
      outlets: Array(8).fill(null),
      error: err?.message || String(err),
    };
  } finally {
    try { session.close(); } catch {}
  }
}

module.exports = { pollCyberpower };